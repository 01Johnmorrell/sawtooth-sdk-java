#!/bin/bash -x

set -e

top_dir=$(dirname $(dirname $0))
protos_dir=$top_dir/protos
sdk_dir=$top_dir/sdk/python/sawtooth_protobuf
validator_dir=$top_dir/validator/sawtooth_validator/protobuf

mkdir -p $sdk_dir
mkdir -p $validator_dir

if [ ! -e $sdk_dir/__init__.py ]; then
    touch $sdk_dir/__init__.py
fi
if [ ! -e $validator_dir/__init__.py ]; then
    touch $validator_dir/__init__.py
fi
counter=0
for pkg in sawtooth_protobuf protobuf
do
    tmp_dir=/tmp/protogen-$$
    mkdir -p $tmp_dir
    mkdir -p $tmp_dir/$pkg
    for file in $(cd $protos_dir && /bin/ls -1 *.proto)
    do
        if [[ $file = [!t]*.proto ]];
        then
            cat $protos_dir/$file \
            | sed -e "s/@PACKAGE@/$pkg/" \
            > $tmp_dir/$file
        else
            cat $protos_dir/$file > $tmp_dir/$pkg/$file
        fi
    done
    if [ $counter = 0 ];
    then
        out_dir=$sdk_dir
    else
        out_dir=$validator_dir
    fi
    counter=$(($counter+1))
    python3 -m grpc.tools.protoc \
        -I$tmp_dir \
        --python_out=$out_dir \
        $tmp_dir/*.proto \
        $tmp_dir/$pkg/*.proto
    rm -rf $tmp_dir
    mv $out_dir/$pkg/*_pb2.py $out_dir
    rm -rf $out_dir/$pkg
done
